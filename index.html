<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Dealer Visit — Location Check</title>
  <style>
    :root { color-scheme: light dark; }
    body { font-family: system-ui, Arial, sans-serif; margin: 24px; }
    .card { max-width: 760px; margin: 0 auto; padding: 20px; border: 1px solid #ddd; border-radius: 12px; }
    h2 { margin-top: 0; }
    label { display:block; margin: 12px 0 6px; font-weight: 600; }
    input, button { padding: 10px; width: 100%; box-sizing: border-box; }
    button { cursor: pointer; }
    .row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    .ok { color: #0a7b22; font-weight: 700; }
    .warn { color: #b45309; font-weight: 700; }
    .err { color: #b91c1c; font-weight: 700; }
    .muted { color: #666; font-size: 0.92rem; }
    .badge { display:inline-block; padding:2px 8px; border:1px solid #ddd; border-radius: 999px; margin-left:8px; font-size: 0.85rem; }
    .pill { display:inline-block; padding:6px 10px; border:1px solid #ddd; border-radius:999px; margin:6px 6px 0 0; cursor:pointer; }
    .hidden { display:none; }
  </style>
</head>
<body>
  <div class="card">
    <h2>Dealer Visit — Location Check</h2>
    <p class="muted">Select the dealer, get your GPS position, and if you’re within the allowed radius, the Google Form button will unlock.</p>

    <!-- ====== CONFIG (edit as needed) ====== -->
    <input type="hidden" id="CSV_URL" value="https://docs.google.com/spreadsheets/d/e/2PACX-1vS3Hpp6N8pjYkRMy-Pi58yCxZB5o-rCdQfnBv0Z_vHMq6Uii5uxG60BnpQVcsyDTg-X9-A-HPodXhpT/pub?output=csv">
    <input type="hidden" id="FORM_URLS" value='{
      "monday": "https://script.google.com/a/*/macros/s/AKfycby2s29BXebDTKgAYjeT76PbCyUBvrZV0YNdSF4JaJesiCjDdi25BiYpcVBLkIwV8GEzgA/exec",
      "tuesday": "https://script.google.com/a/*/macros/s/AKfycby2s29BXebDTKgAYjeT76PbCyUBvrZV0YNdSF4JaJesiCjDdi25BiYpcVBLkIwV8GEzgA/exec",
      "wednesday": "https://script.google.com/a/*/macros/s/AKfycby2s29BXebDTKgAYjeT76PbCyUBvrZV0YNdSF4JaJesiCjDdi25BiYpcVBLkIwV8GEzgA/exec",
      "thursday": "https://script.google.com/a/*/macros/s/AKfycby2s29BXebDTKgAYjeT76PbCyUBvrZV0YNdSF4JaJesiCjDdi25BiYpcVBLkIwV8GEzgA/exec",
      "friday": "https://script.google.com/a/*/macros/s/AKfycby2s29BXebDTKgAYjeT76PbCyUBvrZV0YNdSF4JaJesiCjDdi25BiYpcVBLkIwV8GEzgA/exec",
      "saturday": "https://script.google.com/a/*/macros/s/AKfycby2s29BXebDTKgAYjeT76PbCyUBvrZV0YNdSF4JaJesiCjDdi25BiYpcVBLkIwV8GEzgA/exec"
    }'>
    <input type="hidden" id="RADIUS_M" value="50000000000000000000000000000000000000000000000000000">
    <!-- ====================================== -->

    <label for="dealerInput">Search dealer by name</label>
    <input id="dealerInput" type="text" placeholder="Type dealer name…" autocomplete="off">
    <div id="suggestions"></div>

    <div class="row" style="margin-top:8px;">
      <div>
        <label>Dealer Coordinates</label>
        <input id="dealerCoords" type="text" disabled placeholder="—" />
      </div>
      <div>
        <label>Your Live GPS</label>
        <input id="myCoords" type="text" disabled placeholder="—" />
      </div>
    </div>

    <div class="row">
      <div>
        <label>Distance to Dealer (meters)</label>
        <input id="distance" type="text" disabled placeholder="—" />
      </div>
      <div>
        <label>Status</label>
        <input id="status" type="text" disabled placeholder="—" />
      </div>
    </div>

    <div style="display:grid; grid-template-columns:1fr 1fr 1fr; gap:8px; margin-top:10px;">
      <button id="getGPS">Get My Location</button>
      <button id="reload">Reload Dealer List</button>
      <button id="goForm" disabled>Go to Google Form</button>
    </div>

    <div style="margin-top:8px;">
      <span id="radiusInfo" class="badge"></span>
      <span id="accInfo" class="badge hidden"></span>
    </div>

    <p class="muted" style="margin-top:12px;">Tip: Allow location permission and use a phone outdoors for better accuracy.</p>
  </div>

  <script>
    // ===== Utilities =====
    const sleep = (ms) => new Promise(r => setTimeout(r, ms));
    const parseCSV = (text) => text.trim().split(/\r?\n/).map(line => line.split(","));
    const toRad = (d) => d * Math.PI / 180;
    const haversineMeters = (lat1, lon1, lat2, lon2) => {
      const R = 6371000;
      const dLat = toRad(lat2 - lat1);
      const dLon = toRad(lon2 - lon1);
      const a = Math.sin(dLat/2)**2 + Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) * Math.sin(dLon/2)**2;
      return R * (2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)));
    };

    // ===== State =====
    const csvUrl = document.getElementById("CSV_URL").value;
    const formUrls = JSON.parse(document.getElementById("FORM_URLS").value);
    const RADIUS_M = parseInt(document.getElementById("RADIUS_M").value, 10);

    const dealerInput = document.getElementById("dealerInput");
    const suggestions = document.getElementById("suggestions");
    const dealerCoords = document.getElementById("dealerCoords");
    const myCoords = document.getElementById("myCoords");
    const distanceEl = document.getElementById("distance");
    const statusEl = document.getElementById("status");
    const getGPSBtn = document.getElementById("getGPS");
    const reloadBtn = document.getElementById("reload");
    const goFormBtn = document.getElementById("goForm");
    const radiusInfo = document.getElementById("radiusInfo");
    const accInfo = document.getElementById("accInfo");

    let DEALERS = [];
    let SELECTED = null;
    let MYLOC = null;

    radiusInfo.textContent = `Allowed radius: ${RADIUS_M} m`;

    // ===== Load Dealers =====
    async function loadDealers() {
      suggestions.innerHTML = `<span class="muted">Loading dealers…</span>`;
      try {
        const bust = (csvUrl.includes("?") ? "&" : "?") + "t=" + Date.now();
        const res = await fetch(csvUrl + bust, { cache: "no-store" });
        if (!res.ok) throw new Error("Cannot fetch dealer CSV");

        const text = await res.text();
        const rows = parseCSV(text);
        const header = rows.shift().map(h => h.trim().toLowerCase());
        const iName = header.indexOf("dealername");
        const iLat = header.indexOf("latitude");
        const iLng = header.indexOf("longitude");

        if (iName < 0 || iLat < 0 || iLng < 0) {
          throw new Error("CSV header must include DealerName, Latitude, Longitude");
        }

        DEALERS = rows.map(r => ({
          name: (r[iName] || "").trim(),
          lat: parseFloat(r[iLat]),
          lng: parseFloat(r[iLng])
        })).filter(d => d.name && Number.isFinite(d.lat) && Number.isFinite(d.lng));

        suggestions.innerHTML = `<span class="muted">${DEALERS.length} dealers loaded.</span>`;
      } catch (e) {
        suggestions.innerHTML = `<span class="err">Error: ${e.message}</span>`;
      }
    }
    loadDealers();
    reloadBtn.addEventListener("click", loadDealers);

    // ===== Autocomplete =====
    let lastQuery = "";
    dealerInput.addEventListener("input", async (e) => {
      const q = e.target.value.trim().toLowerCase();
      lastQuery = q;

      if (!q) {
        SELECTED = null;
        dealerCoords.value = "";
        suggestions.innerHTML = "";
        updateGate();
        return;
      }

      await sleep(60);
      if (q !== lastQuery) return;

      const list = DEALERS.filter(d => d.name.toLowerCase().includes(q)).slice(0, 8);

      if (list.length === 1 && list[0].name.toLowerCase() === q) {
        setSelected(list[0]);
        suggestions.innerHTML = "";
        return;
      }

      if (!list.length) {
        suggestions.innerHTML = `<span class="muted">No match.</span>`;
        return;
      }

      suggestions.innerHTML = list.map(d =>
        `<span class="pill" data-name="${encodeURIComponent(d.name)}">${d.name}</span>`
      ).join("");

      suggestions.querySelectorAll("[data-name]").forEach(el => {
        el.addEventListener("click", () => {
          const name = decodeURIComponent(el.getAttribute("data-name"));
          const d = DEALERS.find(x => x.name === name);
          if (d) {
            dealerInput.value = d.name;
            setSelected(d);
            suggestions.innerHTML = "";
          }
        });
      });
    });

    function setSelected(d) {
      SELECTED = d;
      dealerCoords.value = `${d.lat.toFixed(6)}, ${d.lng.toFixed(6)}`;
      computeDistance();
    }

    // ===== Geolocation =====
    getGPSBtn.addEventListener("click", () => {
      if (!navigator.geolocation) {
        statusEl.value = "Geolocation not supported";
        statusEl.className = "err";
        return;
      }
      statusEl.value = "Requesting location…";

      navigator.geolocation.getCurrentPosition(
        (pos) => {
          MYLOC = {
            lat: pos.coords.latitude,
            lng: pos.coords.longitude,
            acc: pos.coords.accuracy
          };
          myCoords.value = `${MYLOC.lat.toFixed(6)}, ${MYLOC.lng.toFixed(6)} (±${Math.round(MYLOC.acc)} m)`;
          accInfo.textContent = `Accuracy: ±${Math.round(MYLOC.acc)} m`;
          accInfo.classList.remove("hidden");
          computeDistance();
        },
        (err) => {
          statusEl.value = `Location error: ${err.message}`;
          statusEl.className = "err";
        },
        { enableHighAccuracy: true, timeout: 15000, maximumAge: 0 }
      );
    });

    // ===== Gate Logic =====
    function computeDistance() {
      if (!SELECTED || !MYLOC) {
        updateGate();
        return;
      }
      const dist = Math.round(haversineMeters(MYLOC.lat, MYLOC.lng, SELECTED.lat, SELECTED.lng));
      distanceEl.value = dist;

      const ok = dist <= RADIUS_M;
      statusEl.value = ok ? "WITHIN RADIUS" : "OUT OF RADIUS";
      statusEl.className = ok ? "ok" : "warn";
      goFormBtn.disabled = !ok;
    }

    function updateGate() {
      if (!SELECTED && !MYLOC) {
        statusEl.value = "Select dealer & get GPS";
      } else if (!SELECTED) {
        statusEl.value = "Select dealer";
      } else if (!MYLOC) {
        statusEl.value = "Get GPS";
      }
      statusEl.className = "";
      goFormBtn.disabled = true;
      distanceEl.value = "";
    }

    // ===== Form Redirect =====
    goFormBtn.addEventListener("click", () => {
      if (goFormBtn.disabled) return;

      const currentDay = new Date().getDay(); // 0=Sunday
      const days = ['sunday','monday','tuesday','wednesday','thursday','friday','saturday'];

      if (currentDay === 0) {
        alert("Sales not working on Sunday.");
        return;
      }
      window.location.href = formUrls[days[currentDay]];
    });
  </script>
</body>
</html>
